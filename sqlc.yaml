version: "2"

sql:
  - engine: "postgresql"
    queries: "db/query.sql"
    schema: "db/schema.sql"
    database:
      uri: '${PG_DSN}'
    gen:
      go:
        package: "q"
        out: "q"
        sql_package: "pgx/v5"
        overrides:
          - db_type: "uuid"
            go_type:
              import: "github.com/gofrs/uuid/v5"
              type: "UUID"
    rules:
      - debug
      - no-delete
      - has-index

rules:
  - name: debug
    rule: "!has(postgresql.explain)" # A dummy rule to trigger explain

  - name: no-delete
    message: "don't use delete statements"
    rule: |
      query.sql.contains("DELETE")

  - name: has-index
    rule: >
      query.sql.startsWith("SELECT") &&
      !(postgresql.explain.plan.plans.all(p, has(p.index_name) || p.plans.all(p, has(p.index_name))))
